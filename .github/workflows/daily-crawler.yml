name: Daily Community Crawler

on:
  schedule:
    # UTC+0 ê¸°ì¤€ì´ë¯€ë¡œ í•œêµ­ì‹œê°„ ì˜¤í›„ 7ì‹œ
    - cron: '0 10 * * *'
    # UTC+0 ê¸°ì¤€ì´ë¯€ë¡œ í•œêµ­ì‹œê°„ ì˜¤ì „ 7ì‹œ
    - cron: '0 22 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run crawler
      env:
        PYTHONPATH: .
      run: |
        python dev/crawl_only.py

    - name: Debug Python Path
      run: |
        python -c "import sys; print(sys.path)"
        
    - name: Generate static HTML from crawled data
      run: |
        python -c "
        import sys, os, shutil
        sys.path.append('.')
        from app import create_app
        from app.models import Post
        from flask import render_template
        from datetime import datetime

        app = create_app()
        
        # Flask ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ì™€ ìš”ì²­ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
        with app.app_context():
            with app.test_request_context():
                posts = Post.query.order_by(Post.crawled_at.desc()).limit(50).all()
                
                # ì‚¬ì´íŠ¸ ì •ë³´ ì •ì˜
                sites = {
                    'ppomppu': {'name': 'ë½ë¿Œ', 'enabled': True},
                    'fmkorea': {'name': 'fmkorea', 'enabled': True},
                    'bobae': {'name': 'ë³´ë°°ë“œë¦¼', 'enabled': True},
                    'dcinside': {'name': 'ë””ì‹œì¸ì‚¬ì´ë“œ', 'enabled': True}
                }
                
                # ì •ì  HTML í…œí”Œë¦¿ ë Œë”ë§
                html = render_template('static.html', 
                                     posts=posts, 
                                     sites=sites,
                                     last_updated=datetime.now().strftime('%Y-%m-%d %H:%M'))
                
                # HTMLì—ì„œ ìƒëŒ€ ê²½ë¡œë¡œ ë³€ê²½ (ë°°í¬ í™˜ê²½ì—ì„œ ì‘ë™í•˜ë„ë¡)
                html = html.replace('href=\"/static/', 'href=\"static/')
                html = html.replace('src=\"/static/', 'src=\"static/')
            
            # HTML íŒŒì¼ ì €ì¥
            with open('index.html', 'w', encoding='utf-8') as f:
                f.write(html)
            
            # CSSì™€ JS íŒŒì¼ì„ ì •ì  íŒŒì¼ë¡œ ë³µì‚¬
            os.makedirs('static/css', exist_ok=True)
            os.makedirs('static/js', exist_ok=True)
            
            if os.path.exists('app/static/css/style.css'):
                shutil.copy2('app/static/css/style.css', 'static/css/style.css')
            if os.path.exists('app/static/js/app.js'):
                shutil.copy2('app/static/js/app.js', 'static/js/app.js')
            
            print(f'Static HTML generated using template with {len(posts)} posts')
            print('Static files (CSS, JS) copied successfully')
        "
        
    - name: Commit and push updated files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git diff --staged --quiet || git commit -m "ğŸ”„ Auto update: $(date '+%Y-%m-%d %H:%M')"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}