name: Daily Community Crawler

on:
  schedule:
    # UTC+0 기준이므로 한국시간 오후 7시
    - cron: '0 10 * * *'
    # UTC+0 기준이므로 한국시간 오전 7시
    - cron: '0 22 * * *'
  
  # 수동 실행 가능
  workflow_dispatch:

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run crawler
      run: |
        set PYTHONPATH=%cd%
        python dev/crawl_only.py
      shell: cmd
        
    - name: Generate static HTML from crawled data
      run: |
        python -c "
        import sys, os
        sys.path.append('.')
        from app import create_app
        from app.models import Post
        from datetime import datetime
        
        app = create_app()
        with app.app_context():
            posts = Post.query.order_by(Post.crawled_at.desc()).limit(50).all()
            site_names = {'bobae': '보배드림', 'ppomppu': '뽐뿌', 'fmkorea': 'fmkorea', 'dcinside': '디시인사이드'}
            
            posts_html = ''
            for post in posts:
                stats_html = ''
                if post.views: stats_html += f'<span>👀 {post.views:,}</span>'
                if post.likes: stats_html += f'<span>❤️ {post.likes:,}</span>'
                if post.comments: stats_html += f'<span>💬 {post.comments:,}</span>'
                
                posts_html += f'<div class=\"post-card\"><div class=\"post-header\"><span class=\"site-badge {post.site}\">{site_names.get(post.site, post.site)}</span></div><div class=\"post-title\"><a href=\"{post.url}\" target=\"_blank\">{post.title}</a></div><div class=\"post-meta\"><span>👤 {post.author or \"익명\"}</span><div class=\"post-stats\">{stats_html}</div></div></div>'
            
            html = f'<!DOCTYPE html><html lang=\"ko\"><head><meta charset=\"UTF-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"><title>한국 커뮤니티 핫이슈</title><style>body{{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f5f5f5}}.container{{max-width:1200px;margin:0 auto}}.header{{text-align:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:2rem;border-radius:10px;margin-bottom:2rem}}.post-card{{background:white;border-radius:10px;padding:1rem;margin:1rem 0;box-shadow:0 2px 4px rgba(0,0,0,0.1)}}.site-badge{{padding:4px 8px;border-radius:4px;color:white;font-size:0.9em}}.bobae{{background:#e74c3c}}.ppomppu{{background:#3498db}}.fmkorea{{background:#f39c12}}.dcinside{{background:#9b59b6}}.post-title a{{text-decoration:none;color:#333;font-weight:bold}}.post-meta{{display:flex;justify-content:space-between;align-items:center;margin-top:0.5rem;font-size:0.9em;color:#666}}.post-stats span{{margin-right:10px}}</style></head><body><div class=\"container\"><header class=\"header\"><h1>🔥 커뮤니티 핫이슈</h1><p>실시간 업데이트 - 총 {len(posts)}개의 인기 게시물</p></header><div class=\"posts-container\">{posts_html}</div><footer style=\"text-align:center;margin-top:2rem;color:#666\"><p>마지막 업데이트: {datetime.now().strftime(\"%Y-%m-%d %H:%M\")}</p><p><a href=\"https://github.com/reomoon/community\">GitHub</a></p></footer></div></body></html>'
            
            with open('index.html', 'w', encoding='utf-8') as f:
                f.write(html)
            print(f'Static HTML generated with {len(posts)} posts')
        "
        
    - name: Commit and push updated files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git diff --staged --quiet || git commit -m "🔄 Auto update: $(date '+%Y-%m-%d %H:%M')"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}