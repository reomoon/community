name: Daily Community Crawler

on:
  schedule:
    # # UTC+0 기준이므로 한국시간 오후 7시
    # - cron: '0 10 * * *'
    # UTC+0 기준이므로 한국시간 오전 7시
    - cron: '0 22 * * *'
  
  # 수동 실행 가능
  workflow_dispatch:

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run crawler
      env:
        PYTHONPATH: .
      run: |
        python dev/crawl_only.py 2>&1 || echo "크롤링 중 일부 오류 발생했지만 계속 진행"

    - name: Debug Python Path
      run: |
        python -c "import sys; print(sys.path)"
        
    - name: Generate static HTML from crawled data
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      run: |
        python -c "
        import sys, os, shutil
        sys.path.append('.')
        from app import create_app
        from app.models import Post
        from flask import render_template
        from datetime import datetime

        app = create_app()
        
        with app.app_context():
            with app.test_request_context():
                from app.models import db
                
                # 모든 게시물 가져오기
                all_posts = Post.query.order_by(Post.crawled_at.desc()).all()
                
                # Python으로 사이트 우선순위 정렬: 보배 -> 디시 -> 뽐뿌 -> 에펨 순
                site_priority = {'bobae': 0, 'dcinside': 1, 'ppomppu': 2, 'fmkorea': 3}
                
                posts = sorted(all_posts, key=lambda x: (site_priority.get(x.site, 99), -x.crawled_at.timestamp()))[:50]
                
                sites = {
                    'bobae': {'name': '보배드림', 'enabled': True},
                    'dcinside': {'name': '디시인사이드', 'enabled': True},
                    'ppomppu': {'name': '뽐뿌', 'enabled': True},
                    'fmkorea': {'name': '에펨코리아', 'enabled': True}
                }
                
                # 한국시간으로 변경 (UTC+9)
                from datetime import timezone, timedelta
                kst = timezone(timedelta(hours=9))
                
                # Vercel Analytics API에서 실제 방문자 데이터 가져오기
                import requests
                import os
                
                try:
                    # 토큰 테스트: 직접 값 넣어서 확인
                    vercel_token = 'kvRod26jx5VVQoqMIAcRzLFy'  # 직접 토큰 입력
                    # vercel_token = os.environ.get('VERCEL_TOKEN')  # 나중에 다시 사용
                    
                    print(f'토큰 확인: {vercel_token[:10]}...{vercel_token[-5:] if vercel_token else None}')
                    
                    if vercel_token:
                        headers = {
                            'Authorization': f'Bearer {vercel_token}',
                            'Content-Type': 'application/json'
                        }
                        
                        # Vercel API로 프로젝트 목록 먼저 확인
                        projects_response = requests.get(
                            'https://api.vercel.com/v9/projects',
                            headers=headers
                        )
                        
                        print(f'프로젝트 API Status: {projects_response.status_code}')
                        
                        if projects_response.status_code == 200:
                            projects_data = projects_response.json()
                            print(f'프로젝트 목록: {projects_data}')
                            
                            # 임시 값 사용
                            today_visitors = 28
                            total_visitors = 342
                        else:
                            print(f'프로젝트 API 오류: {projects_response.text}')
                            raise Exception(f'프로젝트 API 오류: {projects_response.status_code}')
                    else:
                        raise Exception('토큰이 없습니다')
                        
                except Exception as e:
                    print(f'방문자 통계 생성 오류: {e}')
                    # fallback: 기본값 사용
                    total_visitors = 250
                    today_visitors = 25
                
                html = render_template('static.html', 
                                     posts=posts, 
                                     sites=sites,
                                     total_visitors=total_visitors,
                                     today_visitors=today_visitors,
                                     last_updated=datetime.now(kst).strftime('%Y-%m-%d %H:%M'))
            
            with open('index.html', 'w', encoding='utf-8') as f:
                f.write(html)
            
            os.makedirs('static/css', exist_ok=True)
            os.makedirs('static/js', exist_ok=True)
            
            if os.path.exists('app/static/css/style.css'):
                shutil.copy2('app/static/css/style.css', 'static/css/style.css')
            if os.path.exists('app/static/js/app.js'):
                shutil.copy2('app/static/js/app.js', 'static/js/app.js')
            
            print(f'Static HTML generated using template with {len(posts)} posts')
            print('Static files copied successfully')
        "
        
    - name: Commit and push updated files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git add -f output/
        git diff --staged --quiet || git commit -m "🔄 Auto update: $(date '+%Y-%m-%d %H:%M') - 크롤링 완료"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}