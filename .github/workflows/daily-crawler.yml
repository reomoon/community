name: Daily Community Crawler

on:
  schedule:
    # UTC+0 ê¸°ì¤€ì´ë¯€ë¡œ í•œêµ­ì‹œê°„ ì˜¤í›„ 7ì‹œ
    - cron: '0 10 * * *'
    # UTC+0 ê¸°ì¤€ì´ë¯€ë¡œ í•œêµ­ì‹œê°„ ì˜¤ì „ 7ì‹œ
    - cron: '0 22 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run crawler
      run: |
        python dev/crawl_only.py
        
    - name: Generate static HTML from crawled data
      run: |
        python -c "
        import sys, os
        sys.path.append('.')
        from app import create_app
        from app.models import Post
        from datetime import datetime

        app = create_app()
        with app.app_context():
            posts = Post.query.order_by(Post.crawled_at.desc()).limit(50).all()
            site_names = {'bobae': 'ë³´ë°°ë“œë¦¼', 'ppomppu': 'ë½ë¿Œ', 'fmkorea': 'fmkorea', 'dcinside': 'ë””ì‹œì¸ì‚¬ì´ë“œ'}

            posts_html = ''
            for post in posts:
                stats_html = ''
                if post.views: stats_html += f'<span>ì¡°íšŒìˆ˜: {post.views:,}</span>'
                if post.likes: stats_html += f'<span>ì¢‹ì•„ìš”: {post.likes:,}</span>'
                if post.comments: stats_html += f'<span>ëŒ“ê¸€: {post.comments:,}</span>'

                posts_html += f'<div class=\"post-card\"><div class=\"post-header\"><span class=\"site-badge {post.site}\">{site_names.get(post.site, post.site)}</span></div><div class=\"post-title\"><a href=\"{post.url}\" target=\"_blank\">{post.title}</a></div><div class=\"post-meta\"><span>ğŸ‘¤ {post.author or \"ìµëª…\"}</span><div class=\"post-stats\">{stats_html}</div></div></div>'

            html = f'<!DOCTYPE html><html lang=\"ko\"><head><meta charset=\"UTF-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"><title>í•œêµ­ ì»¤ë®¤ë‹ˆí‹° í•«ì´ìŠˆ</title><link rel=\"stylesheet\" href=\"static/css/style.css\"></head><body><div class=\"container\"><header class=\"header\"><h1>ğŸ”¥ ì»¤ë®¤ë‹ˆí‹° í•«ì´ìŠˆ</h1><p>ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ - ì´ {len(posts)}ê°œì˜ ì¸ê¸° ê²Œì‹œë¬¼</p></header><div class=\"posts-container\">{posts_html}</div><footer style=\"text-align:center;margin-top:2rem;color:#666\"><p>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {datetime.now().strftime(\"%Y-%m-%d %H:%M\")}</p><p><a href=\"https://github.com/reomoon/community\">GitHub</a></p></footer></div></body></html>'

            with open('index.html', 'w', encoding='utf-8') as f:
                f.write(html)
            print(f'Static HTML generated with {len(posts)} posts')
        "
        
    - name: Commit and push updated files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git diff --staged --quiet || git commit -m "ğŸ”„ Auto update: $(date '+%Y-%m-%d %H:%M')"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}